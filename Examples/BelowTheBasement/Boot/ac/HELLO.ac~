# -------------------------------
# HELLO FILE FOR 
# BELOW THE BASEMENT
# -------------------------------
FN AVM_RESTORE_RESETV();

# READ ROM, WRITE RAM BANK 2
CONST WRRAM2 $C081;

# DOS STUFF
CONST DOS_COLD  $9D84;
CONST BASIC_PATCH $E3D0;
CONST DOS_ENTRY $9DEA;

# MACHINE CODE STUFF
CONST RTS	$60;
CONST JMP	$6C;

# STRING DATA
DATA INSTALL_AS     "INSTALL.APPLESOFT.OBJ";
DATA ROM_77	    "ROM.77.EDITOR.OBJ";
DATA INSTALL_EDITOR "INSTALL.SHELL.EDITOR.OBJ";
DATA HEXCONVERT	    "HEXCONVERT.OBJ";
DATA BTB	    "BTB.OBJ";

FN AVM_UNPATCH_DOS();

VAR TIME2:1=0;
VAR SAVE:3;

FN MAIN() {
  VAR X:1;
  IF (TIME2) {
    # RESTORE DOS
    SET BASIC_PATCH[0,3]=SAVE;
    # FINISH COLD START
    DOS_ENTRY();
    SET $3F2[0,1]=$FA;
    SET $3F2[1,1]=$9C;
    SET $3F2[2,1]=$39;
    PRINT_STRING(DOS_BRUN);
    PRINT_STRING(BTB);
    MON_CROUT();
  }
  ELSE {
    SET X=WRRAM2[0,1];
    SET X=WRRAM2[0,1];
    PRINT_STRING(DOS_BLOAD);
    PRINT_STRING(ROM_77);
    MON_CROUT();
    SET SAVE=BASIC_PATCH[0,3];
    SET BASIC_PATCH[0,1]=$4C;
    SET BASIC_PATCH[1,2]=$2000;
    RUN(INSTALL_EDITOR);
    # DO DOS COLD START, THEN GO BACK TO MAIN
    SET TIME2=1;
    DOS_COLD();
  }
}

# ADDRESS OF LAST BLOAD
CONST BLOAD_ADDR $AA72;
# -------------------------------
# LOAD AND RUN FILE
# -------------------------------
FN RUN(FILE:2) {
  # LOAD THE FILE
  PRINT_STRING(DOS_BLOAD);
  PRINT_STRING(FILE);
  MON_CROUT();
  # RUN IT
  BLOAD_ADDR[0,2]();
}

INCLUDE "MON.EQ,D2";
INCLUDE "DOS,D2";
INCLUDE "DOS.ASM,D2";
INCLUDE "IO,D2";

